name: manual deployment to ocp

on:
  workflow_dispatch:
    inputs:
      environment:
        type: string
        description: "Enter environment: dev | main | release-x.y.z"
        required: true

jobs:
  deploy:
    runs-on: [self-hosted]

    env:
      REGISTRY: ghcr.io

    steps:
      - name: Clean workspace
        run: rm -rf ./* || true      

      - name: Checkout selected branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.environment }}

      - name: Extract version + namespace + folder
        id: config
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "Selected environment: $ENV"

          MAIN_VERSION=$(grep '^version_main:' version.txt | awk '{print $2}')
          DEV_VERSION=$(grep  '^version_dev:'  version.txt | awk '{print $2}')

          if [ "$ENV" = "dev" ]; then
            VERSION="$DEV_VERSION"
            NAMESPACE="dev"
            DEPLOY_DIR="deploy-dev"
            DEPLOYMENT_NAME="asksupport-bot-dev"

          elif [ "$ENV" = "main" ]; then
            VERSION="$MAIN_VERSION"
            NAMESPACE="llm"
            DEPLOY_DIR="deploy-prod"
            DEPLOYMENT_NAME="slack-bot-prod"

          elif [[ "$ENV" == release-* ]]; then
            VERSION="${ENV#release-}"
            NAMESPACE="llm"
            DEPLOY_DIR="deploy-prod"
            DEPLOYMENT_NAME="slack-bot-prod"
            echo "Extracted release version: $VERSION"

          else
            echo "❌ ERROR: Invalid environment. Allowed: dev | main | release-x.y.z"
            exit 1
          fi

          echo "version=$VERSION"             >> $GITHUB_OUTPUT
          echo "namespace=$NAMESPACE"         >> $GITHUB_OUTPUT
          echo "deploy_dir=$DEPLOY_DIR"       >> $GITHUB_OUTPUT
          echo "deployment=$DEPLOYMENT_NAME"  >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=${{ env.REGISTRY }}/ibm-oss-support/slack-bot:$VERSION" >> $GITHUB_ENV

      - name: Write CA cert to file
        run: printf '%s' "${{ secrets.OCP_CA_CERT }}" > /tmp/ca.crt

      - name: Log in to OpenShift
        run: |
          oc login --server=${{ secrets.OCP_SERVER }} \
                   -u ${{ secrets.OCP_USERNAME }} \
                   -p ${{ secrets.OCP_PASSWORD }} \
                   --certificate-authority=/tmp/ca.crt

      - name: Login to registries
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | podman login docker.io -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          echo "${{ secrets.GHCR_PAT }}"       | podman login ghcr.io     -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build image
        run: |
          podman build -t $IMAGE_NAME . > /tmp/build.log 2>&1 || {
            echo "❌ Build failed"
            cat /tmp/build.log
            exit 1
          }

      - name: Push image
        run: |
          podman push $IMAGE_NAME > /tmp/push.log 2>&1 || {
            echo "❌ Push failed"
            cat /tmp/push.log
            exit 1
          }

      - name: Replace version in manifests
        run: |
          cd "${{ steps.config.outputs.deploy_dir }}"
          find . -type f -name '*.yaml' -exec sed -i \
            "s|__VERSION__|${{ steps.config.outputs.version }}|g" {} +

      - name: Switch namespace
        run: oc project ${{ steps.config.outputs.namespace }}

      - name: Validate manifests
        run: |
          cd "${{ steps.config.outputs.deploy_dir }}"
          for f in *.yaml; do
            oc apply --dry-run=client -f "$f"
          done

      - name: Apply manifests
        run: oc apply -f "${{ steps.config.outputs.deploy_dir }}"

      - name: Restart and wait for rollout
        run: |
          DEPLOYMENT="${{ steps.config.outputs.deployment }}"

          echo "Restarting deployment: $DEPLOYMENT"
          oc rollout restart deployment/$DEPLOYMENT -n ${{ steps.config.outputs.namespace }}

          echo "Waiting for rollout..."
          oc rollout status deployment/$DEPLOYMENT -n ${{ steps.config.outputs.namespace }} >> /tmp/rollout.log 2>&1 || {
            echo "❌ Rollout failed: $DEPLOYMENT"
            cat /tmp/rollout.log
            exit 1
          }

      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-deploy-logs
          path: |
            /tmp/build.log
            /tmp/push.log
            /tmp/deploy.log
            /tmp/rollout.log
